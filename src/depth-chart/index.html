<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Depth Chart</title>
  <script src="https://unpkg.com/react@latest/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
  //  Prices must be sorted for highcharts
  const orderBookSeries = {
    bids: [
      [.02, 200],
      [.05, 20],
      [.10, 120],
      [.12, 1430],
      [.13, 130],
      [.14, 130],
      [.145, 130],
      [.15, 130],
      [.16, 1240],
      [.17, 140],
      [.20, 1230],
      [.30, 1],
      [.40, 10],
      [.43, 150],
      [.44, 150]
    ],
    asks: [
      [.995, 1000],
      [.99, 100],
      [.98, 1000],
      [.94, 100],
      [.91, 100],
      [.88, 1000],
      [.87, 1000],
      [.86, 1000],
      [.85, 1000],
      [.75, 100],
      [.65, 1020],
      [.64, 10],
      [.63, 120],
      [.62, 100],
      [.615, 1020],
      [.59, 10],
      [.55, 120],
      [.45, 1000],
      [.445, 100],
    ]
  };

//  import noData from 'highcharts/modules/no-data-to-display';

  class OrderBookDepthChart extends React.Component {
    constructor(props) {
      super(props);
      this.state = {};
      this.updateChart = this.updateChart.bind(this);
      this.calcSideData = this.calcSideData.bind(this);
    }

    componentDidMount() {
//      noData(Highcharts); when back in augur UI repo
      Highcharts.setOptions({
        lang: {
          thousandsSep: ','
        }
      });

      this.depthChart = new Highcharts.Chart('depth_chart', {
        chart: {
          backgroundColor: 'lightgrey',
          height: 300,
          width: 300,
          type: 'bar',
        },
        title: {
          text: '',
          style: {
            color: '#000',
            fontSize: '11px'
          }
        },
        lang: {
          thousandsSep: ',',
          noData: 'No orders to display'
        },
        xAxis: {
          title: {
            text: ''
          },
          tickInterval: .05,
          max: 1,
          labels: {
            rotation: 90
          },
          opposite: true
        },
        yAxis: [{
          title: {
            text: ''
          },
          showLastLabel: true,
          opposite: true
        }],
        series: [
          {
            showInLegend: false,
            name: '',
            type: 'line',
            color: 'red'
          },
          {
            showInLegend: false,
            name: '',
            type: 'line',
            color: 'green'
          }
        ],
        tooltip: {
          headerFormat: null,
          pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y} Shares Available @ {point.x} ETH</b><br/>',
          valueDecimals: 2
        },
        credits: {
          enabled: false
        },
        type: 'line'
      });

      this.updateChart();
    }

    componentDidUpdate(prevProps) {
      if (prevProps.orderBookSeries !== this.props.orderBookSeries) this.updateChart();
    }

    componentWillUnmount() {
      window.removeEventListener('resize', this.updateChart);
    }

    calcSideData(sideSeries, side) {

      if (side === 'asks')  {
        sideSeries.sort(function(a, b) {
          return a[0] - b[0];
        });
      } else {
        sideSeries.sort(function(a, b) {
          return b[0] - a[0];
        });
      }
      const data = [];
      const firstShares = sideSeries[0][1];
      const firstPrice = sideSeries[0][0];
      data.push([firstPrice, firstShares]);// seed so we have the first cumulative numShares

      for (let i = 1; i < sideSeries.length; i++) {
        const order = [];
        const price = sideSeries[i][0];
        order.push(price);
        const currentShares = sideSeries[i][1];
        const currentCumShares = currentShares + data[i - 1][1];
        order.push(currentCumShares);
        data.push(order);
      }

      return data;
    }

    getMidPoint(bids, asks) {

      let maxBid = 0;
      for (const bid of bids) {
        if (bid[0] > maxBid) maxBid = bid[0];
      }
      let minAsk = 1;
      for (const ask of asks) {
        if (ask[0] < minAsk) minAsk = ask[0];
      }
      return maxBid + ((minAsk - maxBid) / 2);
    }

    updateChart() {
      const bidData = this.props.orderBookSeries.bids;
      const askData = this.props.orderBookSeries.asks;

      const bidSeries = this.calcSideData(bidData, 'bids');
      const askSeries = this.calcSideData(askData, 'asks');

      const midPoint = this.getMidPoint(bidSeries, askSeries);
      this.depthChart.setTitle({ text: 'MidPoint: ' + midPoint });
      this.depthChart.series[1].setData(askSeries, false);
      this.depthChart.series[0].setData(bidSeries, false);

      this.depthChart.redraw();
    }

    render() {
      const p = this.props;

      return (
          <article
              className="order-book-chart"
          >
            <h1>Market Depth</h1>
            <div
                id="depth_chart"
            />
          </article>
      );
    }
  }
  ReactDOM.render(
    <OrderBookDepthChart rotation={'90'} orderBookSeries={orderBookSeries} />,
    document.getElementById('root')
  );
</script>
</body>
</html>
