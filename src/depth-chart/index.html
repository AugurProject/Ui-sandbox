<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Depth Chart</title>
  <script src="https://unpkg.com/react@latest/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
</head>
<body style="background-color: #2d2846">
<div id="root"></div>
<script type="text/babel">

//  import noData from 'highcharts/modules/no-data-to-display';
  class OrderBookDepthChart extends React.Component {
    constructor(props) {
      super(props);
      this.updateChart = this.updateChart.bind(this);
      this.calcSideData = this.calcSideData.bind(this);
      this.uglyIlliquidOrderBook = {
        bids: [
          [.02, 200],
          [.40, 10],
          [.43, 10],
          [.44, 150]
        ],
        asks: [
          [.995, 100],
          [.99, 100],
          [.45, 10],
          [.445, 10],
        ]
      };
      this.orderBookOne = {
        bids: [
          [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200],
          [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200], [.02, 200],[.02, 200],[.02, 200],
          [.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],
          [.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],[.02, 200],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],[.05, 20],
          [.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],
          [.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],
          [.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],
          [.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.10, 120],[.11, 120],[.11, 120],
          [.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],
          [.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],
          [.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],
          [.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],[.11, 120],
          [.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],
          [.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],
          [.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],
          [.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],[.12, 1430],
          [.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],[.13, 130],
          [.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],[.14, 130],
          [.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],[.145, 130],
          [.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],
          [.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],
          [.16, 1240],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],[.15, 130],
          [.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],[.17, 140],
          [.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],[.20, 1230],
          [.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],
          [.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],
          [.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],
          [.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],[.31, 123],
          [.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],
          [.32, 1],[.32, 1],[.32, 1],[.32, 1],[.32, 1],
          [.33, 1],
          [.34, 1],[.34, 1],[.34, 1],[.34, 1],[.34, 1],[.34, 1],[.34, 1],[.34, 123],
          [.40, 10],[.40, 10],[.40, 10],[.40, 10],[.40, 10],[.40, 10],[.40, 10],
          [.43, 150],
          [.44, 150]
        ],
        asks: [
          [.995, 1000],
          [.99, 100],
          [.98, 1000],
          [.96, 1000],
          [.95, 1000],
          [.94, 100],
          [.91, 100],
          [.88, 1000],
          [.87, 1000],
          [.64, 10],
          [.63, 10020],
          [.62, 100],
          [.615, 1020],
          [.59, 10],
          [.55, 120],
          [.45, 1000],
          [.445, 100],
        ]
      };
      this.orderBookTwo = {
        bids: [
          [.02, 200],
          [.02, 200],
          [.02, 200],
          [.02, 200],
          [.02, 200],
          [.05, 20],
          [.10, 120],
          [.43, 150],
          [.44, 150]
        ],
        asks: [
          [.995, 1000],
          [.898, 1000],
          [.895, 1000],
          [.89, 1000],
          [.88, 1000],
          [.87, 1000],
          [.64, 10],
          [.62, 100],
          [.445, 100]
        ]
      };
      this.state  = {
        orderBook: this.orderBookOne
      };
    }

    componentDidMount() {
//      noData(Highcharts); TODO when back in augur UI repo
      Highcharts.setOptions({
        lang: {
          thousandsSep: ','
        }
      });

      this.depthChart = new Highcharts.Chart('depth_chart', {
        chart: {
          backgroundColor: '#2d2846',
          height: 350,
          width: 350,
          type: 'bar',
        },
        title: {
          style: {
            color: 'white',
            fontSize: '11px'
          },
          align: 'right',
          x: -200,
          verticalAlign: 'bottom',
          y: -150,
        },
        lang: {
          thousandsSep: ',',
          noData: 'No orders to display'
        },
        xAxis: {
          title: {
            text: ''
          },
          max: 1,
          reverse: true,
          tickWidth: 0,
          lineWidth: 0,
          minorGridLineWidth: 0,
          lineColor: 'transparent',
          minorTickLength: 0,
          tickLength: 0,
          crosshair: {
//          width: 3,
            dashStyle: 'dash',
            width: 1,
            color: '#7257a3',
            zIndex: 22
          }
        },
        yAxis: {
          title: {
            text: ''
          },
          min: 0, // can't do anything with less than 0 shares
          showLastLabel: true,
          gridLineWidth: 0,
          minorGridLineWidth: 0,
          labels: {
            align: 'bottom',
            verticalAlign: 'bottom'
          },
          crosshair: {
//          width: 3,
            dashStyle: 'dash',
            width: 1,
            color: '#7257a3',
            zIndex: 22
          }
        },
        series: [
          {
            showInLegend: false,
            name: '',
            type: 'area',
            color: '#7257a3',
            lineWidth: 3,
            threshold: null,
            fillColor: {
              linearGradient: {
                x1: 0,
                y1: 1,
                x2: 0,
                y2: 0
              },
              stops: [
                [0, '#2d2846'],
                [1, '#3c2d63']
              ]
            },
          },
          {
            showInLegend: false,
            name: '', // TODO correct thing to display?  Needs to be same as series[0]
            type: 'area',
            color: '#7257a3',
            lineWidth: 3,
            threshold: null,
            fillColor: {
              linearGradient: {
                x1: 0,
                y1: 1,
                x2: 0,
                y2: 0
              },
              stops: [
                [0, '#2d2846'],
                [1, '#3c2d63']
              ]
            },
          }
        ],
        tooltip: {
//          pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y} Shares Available <br />@ {point.x} ETH</b><br/>',
          valueSuffix: '',
          formatter: function() {
            return this.point.y + " Shares Available @" + this.point.x + "ETH";
          },
          valueDecimals: 2,
          positioner: function () {
            return { x: 180, y: 130 };
          },
          shadow: false,
          borderWidth: 0,
          backgroundColor: 'rgba(255,255,255,0.4)'
        },
        credits: {
          enabled: false
        }
      });

      setInterval(function () {
        const orderBook = Math.random() > .4999 ? this.orderBookOne : Math.random() > .5 ? this.uglyIlliquidOrderBook : this.orderBookTwo;
        console.log(`Rerendering chart with ${orderBook.asks.length + orderBook.bids.length} total orders`);
        this.setState({
          orderBook: orderBook
        });
        console.time('update chart took');
        this.updateChart();
        console.timeEnd('update chart took');
      }.bind(this), 1600);

    }

//    componentDidUpdate(prevProps) {
//      if (prevProps.orderBookSeries !== this.props.orderBookSeries) this.updateChart();
//    }

    componentWillUnmount() {
      window.removeEventListener('resize', this.updateChart);
    }

    calcSideData(sideSeries, side) {
      if (side === 'asks')  {
        sideSeries.sort(function(a, b) {
          return a[0] - b[0];
        });
      } else {
        sideSeries.sort(function(a, b) {
          return b[0] - a[0];
        });
      }
      const data = [];
      const firstShares = sideSeries[0][1];
      const firstPrice = sideSeries[0][0];
      data.push([firstPrice, firstShares]);// seed so we have the first cumulative numShares

      for (let i = 1; i < sideSeries.length; i++) {
        const order = [];
        const price = sideSeries[i][0];
        order.push(price);
        const currentShares = sideSeries[i][1];
        const currentCumShares = currentShares + data[i - 1][1];
        order.push(currentCumShares);
        data.push(order);
      }

      return data;
    }

    getMidPoint(bids, asks) {
      const maxBid = bids[bids.length - 1][0];
      const minAsk = asks[asks.length - 1][0];
      return maxBid + ((minAsk - maxBid) / 2);
    }

    updateChart() {
      const bidData = this.state.orderBook.bids;
      const askData = this.state.orderBook.asks;

      const bidSeries = this.calcSideData(bidData, 'bids');
      const askSeries = this.calcSideData(askData, 'asks');

      const midPoint = this.getMidPoint(bidSeries, askSeries);
      this.depthChart.setTitle({ text: midPoint });
      this.depthChart.series[0].setData(askSeries, true);
      this.depthChart.series[1].setData(bidSeries, true);

      this.depthChart.redraw();
    }

    render() {
      const p = this.props;

      return (
          <article className="order-book-chart">
            <div
                id="depth_chart"
            />
          </article>
      );
    }
  }

  ReactDOM.render(
    <OrderBookDepthChart />,
    document.getElementById('root')
  );
</script>
</body>
</html>
